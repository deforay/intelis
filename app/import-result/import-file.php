<?php
// this is import-file.php
use App\Services\TestsService;
use App\Registries\AppRegistry;
use App\Services\CommonService;
use App\Services\DatabaseService;
use App\Services\FacilitiesService;
use App\Registries\ContainerRegistry;

// Sanitized values from $request object
/** @var Laminas\Diactoros\ServerRequest $request */
$request = AppRegistry::get('request');
$_GET = _sanitizeInput($request->getQueryParams());

$type = $_GET['t'];

if (empty($type)) {
	// Redirect to dashboard if type is not provided
	header("Location: /dashboard/index.php");
	exit;
}
$title = _translate("Import") . " " . strtoupper((string) $type) . " " . _translate("test results from file");

require_once APPLICATION_PATH . '/header.php';

/** @var DatabaseService $db */
$db = ContainerRegistry::get(DatabaseService::class);

/** @var CommonService $general */
$general = ContainerRegistry::get(CommonService::class);

/** @var FacilitiesService $facilitiesService */
$facilitiesService = ContainerRegistry::get(FacilitiesService::class);




$testName = TestsService::getTestName($type);
$testTableName = TestsService::getTestTableName($type);
$primaryKey = TestsService::getPrimaryColumn($type);

$lastQuery = "SELECT lab_id FROM $testTableName WHERE lab_id is not NULL ORDER BY last_modified_datetime DESC LIMIT 1";

$lastResult = $db->rawQueryOne($lastQuery);

$instrumentsList = $general->getInstruments();
$facilitiesList = $facilitiesService->getFacilitiesForResultUpload($type);


?>
<link rel="stylesheet" media="all" type="text/css" href="/assets/css/smart-date-format.css">
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
	<!-- Content Header (Page header) -->
	<section class="content-header">
		<h1><em class="fa-solid fa-list-check"></em> <?php echo _translate("Import"); ?> <?= strtoupper(htmlspecialchars((string) $type)); ?> <?php echo _translate("Test Results From File"); ?></h1>
		<ol class="breadcrumb">
			<li><a href="/"><em class="fa-solid fa-chart-pie"></em> <?php echo _translate("Home"); ?></a></li>
			<li class="active"><?php echo _translate("Import Result"); ?></li>
		</ol>
	</section>

	<!-- Main content -->
	<section class="content">

		<div class="box box-default">
			<div class="box-header with-border">
				<div class="pull-right" style="font-size:15px;"><span class="mandatory">*</span> <?= _translate("indicates required fields"); ?> &nbsp;</div>
			</div>
			<!-- /.box-header -->
			<div class="box-body">
				<!-- form start -->
				<div style="font-size:1.1em;padding:1em;">
					<h3 style="color:red;font-weight:bold;"><?php echo _translate("Please ensure that the Sample IDs in the import file match the Sample IDs in the LIS."); ?> </h3>

					<p>
						<?php echo _translate("To ensure proper result import :") ?>
					<ol>
						<li><?php echo _translate("Record the Samples in LIS before sending them to Testing machine."); ?></li>
						<li><?php echo _translate("Create a Batch with the samples recorded in the previous step."); ?></li>
						<li><?php echo _translate("Use the Batch to test Samples in Viral Load machines."); ?></li>
						<li><?php echo _translate("Export the result file (containing Sample IDs generated by VLSM) from the VL machine."); ?></li>
						<li><?php echo _translate("Import the file below. Make sure to pick the specific Machine Name/Code."); ?></li>
					</ol>
					</p>


					<form class="form-horizontal" method='post' name='importResultFileForm' id='importResultFileForm' enctype="multipart/form-data" autocomplete="off" action="import-file-helper.php">
						<div class="box-body">
							<div class="row" style="display:block;">
								<div class="col-md-12">
									<div class="row">
										<div class="col-md-6">
											<div class="form-group">
												<label for="machineName" class="col-lg-5 control-label"><?php echo _translate("Instrument/Platform Name"); ?> <span class="mandatory">*</span></label>
												<div class="col-lg-7">
													<select name="machineName" id="machineName" class="form-control isRequired" title="<?php echo _translate('Please select the import machine type'); ?>" onchange="getConfigMachineName();">
														<option value=""> <?php echo _translate("-- Select --"); ?> </option>
														<?php foreach ($instrumentsList as $val) { ?>
															<option value="<?php echo base64_encode((string) $val['instrument_id']); ?>"><?php echo ($val['machine_name']); ?></option>
														<?php } ?>
													</select>
												</div>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-md-6">
											<div class="form-group">
												<label for="machineName" class="col-lg-5 control-label"><?php echo _translate("Specific Machine Name/Code"); ?></label>
												<div class="col-lg-7">
													<select name="configMachineName" id="configMachineName" class="form-control" title="<?php echo _translate('Please select instrument'); ?>">
														<option value=""> <?php echo _translate("-- Select --"); ?> </option>
													</select>
												</div>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-md-6">
											<div class="form-group">
												<label for="dateFormat" class="col-lg-5 control-label">
													<?php echo _translate("Date Format"); ?> <span class="mandatory">*</span>
													<br><small style="font-weight: normal; color: #666; font-size: 11px;">
														ðŸ“… <?php echo _translate("Enter sample date to auto-detect format"); ?>
													</small>
												</label>
												<div class="col-lg-7">
													<div class="smart-date-cell">
														<!-- Smart Date Format Detection Interface -->
														<div style="margin-bottom: 8px;">
															<input type="text"
																name="sampleDateInput"
																id="sampleDateInput"
																class="form-control"
																placeholder="ðŸ“… <?php echo _translate("Enter sample date from your file (e.g., 06.19.2025 11:19 AM)"); ?>"
																title="<?php echo _translate("Enter a sample date from your import file"); ?>"
																style="border: 2px solid #007bff; font-size: 13px;"
																data-smart-date-format
																data-suggestions-container="formatSuggestions"
																data-hidden-field="dateFormat"
																data-manual-input="manualFormatInput"
																data-row-id="import"
																data-default-format="d/m/Y H:i" />
															<small style="color: #666; font-size: 11px;">ðŸ’¡ <?php echo _translate("Enter any date from your import file to auto-detect format"); ?></small>
														</div>

														<!-- Smart Suggestions Container -->
														<div id="formatSuggestions" class="format-suggestions-container"></div>

														<!-- The actual field your backend expects (KEEP EXACT NAMES) -->
														<input type="hidden"
															class="form-control isRequired"
															id="dateFormat"
															name="dateFormat"
															value=""
															placeholder="<?php echo _translate("Date format will appear here"); ?>"
															style="margin-top: 8px; border: 1px solid #28a745; background: #f8fff9;"
															readonly />

														<!-- Manual Format Input (hidden by default) -->
														<div id="manualFormatInput" style="display: none; margin-top: 8px;">
															<input type="text"
																class="form-control"
																placeholder="<?php echo _translate("Manual: d/m/Y H:i"); ?>"
																title="<?php echo _translate("Enter date format manually"); ?>"
																style="border: 1px solid #ccc; font-size: 12px;"
																onchange="document.getElementById('dateFormat').value = this.value;" />
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-md-6">
											<div class="form-group">
												<label for="labId" class="col-lg-5 control-label"><?php echo _translate("Testing Lab Name"); ?> <span class="mandatory">*</span></label>
												<div class="col-lg-7">
													<select name="labId" id="labId" class="form-control isRequired" title="<?php echo _translate('Please select the lab name'); ?>">
														<option value=""> <?php echo _translate("-- Select --"); ?> </option>
														<?php
														foreach ($facilitiesList as $val) {
														?>
															<option value="<?php echo base64_encode((string) $val['facility_id']); ?>" <?php echo (isset($lastResult['lab_id']) && $lastResult['lab_id'] == $val['facility_id']) ? "selected='selected'" : ""; ?>><?php echo ($val['facility_name']); ?></option>
														<?php } ?>
													</select>
												</div>
											</div>
										</div>
									</div>

									<div class="row">
										<div class="col-md-6">
											<div class="form-group">
												<label class="col-lg-5 control-label"><?php echo _translate("Upload"); ?> <?= $testName; ?> <?php echo _translate("File"); ?> <span class="mandatory">*</span></label>
												<div class="col-lg-7">
													<input type="file" class="isRequired" accept=".xls,.xlsx,.csv,.txt,.lis" name="resultFile" id="resultFile" title="<?php echo _translate('Please choose result file'); ?>">
													<?php echo _translate("(Upload xls, xlsx, csv, txt format)"); ?>
												</div>
											</div>
										</div>
									</div>

								</div>

							</div>
							<div class="row">
								<div class="col-md-8">
									<div class="row form-group">
										<div class="box-footer">
											<input type="hidden" id="vltestPlatform" name="vltestPlatform" value="" />
											<input type="hidden" id="type" name="type" value="<?php echo $type; ?>" />
											<!-- <input type="hidden" id="dateFormat" name="dateFormat" value="" /> -->
											<input type="hidden" id="fileName" name="fileName" value="" />
											<a class="btn btn-primary" href="javascript:void(0);" onclick="validateNow();return false;"><?php echo _translate("Submit"); ?></a>
											<a href="/dashboard/index.php" class="btn btn-default"> <?php echo _translate("Cancel"); ?></a>
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- /.box-body -->

						<!-- /.box-footer -->
					</form>
					<!-- /.row -->
				</div>

			</div>
			<!-- /.box -->

	</section>
	<!-- /.content -->
</div>

<?php require_once WEB_ROOT . '/assets/js/smart-date-format.js.php'; ?>
<script type="text/javascript">
	$(document).ready(function() {
		// Initialize Smart Date Format for import form
		SmartDateFormat.init({
			inputId: 'sampleDateInput',
			containerId: 'formatSuggestions',
			hiddenFieldId: 'dateFormat',
			manualInputId: 'manualFormatInput',
			rowId: 'import',
			defaultFormat: 'd/m/Y H:i',
			onFormatSelected: function(format, settings) {
				console.log('Date format selected for import:', format);
			}
		});
	});

	function validateNow() {
		$("#vltestPlatform").val($("#machineName option:selected").text());
		$('#fileName').val($("#configMachineName").find(':selected').data("filename"));

		const flag = deforayValidator.init({
			formId: 'importResultFileForm'
		});

		if (flag) {
			document.getElementById('importResultFileForm').submit();
		}
	}

	$("#machineName").on('change', function() {
		if ($("#machineName").val() == "") {
			$("#vltestPlatform").val("");
		} else {
			$("#vltestPlatform").val($("#machineName option:selected").text());
			$("#configMachineName").trigger("change");
		}
	});

	$("#configMachineName").on('change', function() {
		updateDateFormatFromSelectedMachine();
	});

	// Extracted function to handle date format updates
	function updateDateFormatFromSelectedMachine() {
		// Get the date format from selected machine
		const selectedFormat = $("#configMachineName").find(':selected').data("dateformat");

		if (selectedFormat && selectedFormat !== '') {
			// Update the format field
			$('#dateFormat').val(selectedFormat);

			// Update the sample input to show pre-configured state (but keep it editable)
			const sampleInput = $('#sampleDateInput');
			const helpText = sampleInput.siblings('small').first();
			const container = $('#formatSuggestions');

			// Make sample input show it's pre-configured but still editable
			sampleInput.removeClass('sample-detected format-detected')
				.addClass('format-selected')
				.prop('placeholder', `âœ… Pre-configured: ${selectedFormat} (click to change)`)
				.prop('readonly', false) // Keep it editable!
				.css('cursor', 'text');

			if (helpText.length) {
				helpText.html(`âœ… <strong>Pre-configured format:</strong> <code>${selectedFormat}</code> | Click field to change`)
					.css('color', '#28a745');
			}

			// Mark container as having selection but allow changes
			container.addClass('has-selection').html('');

			// Update the main guidance
			if (window.SmartDateFormat) {
				SmartDateFormat.updateInputGuidance('', SmartDateFormat.getInstance('import'));
			}
		} else {
			// Reset if no format from machine
			$('#dateFormat').val('d/m/Y H:i');

			// Reset the sample input
			const sampleInput = $('#sampleDateInput');
			const helpText = sampleInput.siblings('small').first();
			const container = $('#formatSuggestions');

			sampleInput.removeClass('format-selected sample-detected format-detected')
				.prop('placeholder', 'ðŸ“… Enter sample date from your file')
				.prop('readonly', false)
				.css('cursor', 'text');

			if (helpText.length) {
				helpText.html('ðŸ’¡ Enter any date from your import file to auto-detect format')
					.css('color', '#666');
			}

			container.removeClass('has-selection').html('');
		}
	}

	function getConfigMachineName() {
		if ($("#machineName").val() != '') {
			$.post("/import-result/getConfigMachineName.php", {
					configId: $("#machineName").val()
				},
				function(data) {
					$("#configMachineName").html(data);
					// Apply date format after the dropdown is populated
					updateDateFormatFromSelectedMachine();
				});
		}
	}
</script>
<?php
require_once APPLICATION_PATH . '/footer.php';
