<?php

require_once __DIR__ . "/../../bootstrap.php";

$versionFilePath = APPLICATION_PATH . '/system/version.php';

// Get the manually maintained version from constants.php
$baseVersion = CORE\VERSION;

// Retrieve the Mercurial commit number (short form) and remove any trailing "+"
$commitNumber = trim(shell_exec('hg id -n'));
$commitNumber = rtrim($commitNumber, '+');

// Combine the base version with the commit number
$fullVersion = $baseVersion . '.' . $commitNumber;

// Generate the content for version.php
$versionFileContent = <<<PHP
<?php

// DO NOT MODIFY THIS FILE
// Version is defined in app/system/constants.php
// This file is automatically generated by the build process
defined('VERSION')
    || define('VERSION', '$fullVersion');

PHP;

// Write the new version content to version.php
file_put_contents($versionFilePath, $versionFileContent);

echo "version.php has been updated to version $fullVersion\n";
