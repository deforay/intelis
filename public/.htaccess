# .htaccess
RewriteEngine On
Options -Indexes +FollowSymLinks

# ---- Block sensitive files
<FilesMatch "\.(perl|py|htaccess|htpasswd|ini|log|sh|lock|phar|yml|md|sql|zip|hgignore|hg|hgtags|DS_Store)$">
  Require all denied
</FilesMatch>

# ---- Dynamic compression (gzip only)
<IfModule mod_headers.c>
  Header always append Vary Accept-Encoding
</IfModule>
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE application/json text/plain text/html text/css application/javascript
</IfModule>

<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/css application/javascript
</IfModule>


# ---- Server-Sent Events (no compression, no buffering)
# mark SSE requests via env (either rule below or SetEnvIfNoCase)
RewriteRule ^sse/ - [E=IS_SSE:1]
<IfModule mod_deflate.c>
  SetEnvIfNoCase Request_URI "^/sse/" no-gzip=1
</IfModule>
<IfModule mod_headers.c>
  Header set Cache-Control "no-cache, no-transform" env=IS_SSE
  Header set X-Accel-Buffering "no" env=IS_SSE
</IfModule>

# ---- Avoid double-compress
<IfModule mod_php.c>
  php_flag zlib.output_compression Off
</IfModule>
<IfModule mod_php8.c>
  php_flag zlib.output_compression Off
</IfModule>

# ---- App rewrites
# serve existing files/dirs as-is
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# allow direct access to SSE endpoints
RewriteRule ^sse/ - [L]

# everything else â†’ index.php (front controller)
RewriteRule ^ index.php [L]
