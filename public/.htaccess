RewriteEngine On
Options -Indexes -MultiViews +FollowSymLinks

# ---------- Security headers (optional) ----------
# Header always set X-Frame-Options "SAMEORIGIN"
# Header always edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure
# Header always set X-Content-Type-Options "nosniff"
# Header set Access-Control-Allow-Origin "*"

# ---------- Block sensitive files ----------
<FilesMatch "\.(perl|py|htaccess|htpasswd|ini|psd|log|sh|lock|phar|yml|md|sql|zip|hgignore|hg|hgtags|DS_Store)$">
  Require all denied
</FilesMatch>

# ---------- Dynamic compression ----------
<IfModule mod_headers.c>
  Header always append Vary Accept-Encoding
</IfModule>

<IfModule mod_brotli.c>
  BrotliCompressionQuality 5
  BrotliAlterETag On
  AddOutputFilterByType BROTLI_COMPRESS \
    application/json text/plain text/html text/css application/javascript
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE \
    application/json text/plain text/html text/css application/javascript
</IfModule>

# ---------- SSE: disable compression & buffering (no <Location>) ----------

# Mark SSE requests via URI prefix
RewriteRule ^sse/ - [E=IS_SSE:1]

# Tell proxies not to buffer/transform SSE
<IfModule mod_headers.c>
  Header set Cache-Control "no-cache, no-transform" env=IS_SSE
  Header set X-Accel-Buffering "no" env=IS_SSE
</IfModule>

# Turn off gzip/brotli for SSE using env flags recognized by filters
<IfModule mod_deflate.c>
  SetEnvIfNoCase Request_URI "^/sse/" no-gzip=1
</IfModule>
<IfModule mod_brotli.c>
  SetEnvIfNoCase Request_URI "^/sse/" no-brotli=1
</IfModule>

# ---------- Ensure PHP doesn't double-compress (mod_php only) ----------
<IfModule mod_php.c>
  php_flag zlib.output_compression Off
</IfModule>
<IfModule mod_php8.c>
  php_flag zlib.output_compression Off
</IfModule>

# ---------- App rewrites ----------
# Serve existing files/links/dirs directly
RewriteCond %{REQUEST_FILENAME} -s [OR]
RewriteCond %{REQUEST_FILENAME} -l [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^.*$ - [NC,L]

# Allow direct access to SSE endpoints
RewriteRule ^sse/ - [L]

# Everything else to index.php
RewriteCond %{REQUEST_URI}::$1 ^(/.+)(.+)::\2$
RewriteRule ^(.*) - [E=BASE:%1]
RewriteRule ^(.*)$ %{ENV:BASE}index.php [NC,L]
